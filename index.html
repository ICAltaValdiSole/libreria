<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Libreria Scolastica</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://apis.google.com/js/platform.js" async defer></script>
    <meta name="google-signin-client_id" content="1010871423571-f966tc7s4d9td8u19151ju9ervgb1eml.apps.googleusercontent.com">
</head>
<body>
    <div class="container">
        <h1 class="mt-5">Libreria Scolastica</h1>
        <div class="g-signin2" data-onsuccess="onSignIn" data-theme="dark"></div>
        <div id="libri" class="mt-4">
            <!-- Qui verranno visualizzati i libri -->
        </div>
    </div>

    <script>
        var GoogleAuth; // Google Auth object.
        function initClient() {
            gapi.client.init({
                'apiKey': 'AIzaSyCBAMHlMKwdPs8hlvRnxxNOWwdXxqnKC3k',
                'clientId': '1010871423571-f966tc7s4d9td8u19151ju9ervgb1eml.apps.googleusercontent.com',
                'scope': 'https://www.googleapis.com/auth/spreadsheets',
                'discoveryDocs': ['https://sheets.googleapis.com/$discovery/rest?version=v4']
            }).then(function () {
                GoogleAuth = gapi.auth2.getAuthInstance();
                GoogleAuth.isSignedIn.listen(updateSigninStatus);
            });
        }

        function onSignIn(googleUser) {
            updateSigninStatus(GoogleAuth.isSignedIn.get());
        }

        function updateSigninStatus(isSignedIn) {
            if (isSignedIn) {
                fetchBooks();
            } else {
                console.log('Please log in to view books.');
            }
        }

        function fetchBooks() {
        gapi.client.sheets.spreadsheets.values.get({
        spreadsheetId: '1bHmR_g_8Rp54M1lLnZd3nD78EqRTIKNSzl1mE2-hRzQ',
        range: 'libreriaprincipale!A2:B',  // Nome del foglio aggiornato
    }).then((response) => {
        var range = response.result;
        if (range.values.length > 0) {
            displayBooks(range.values);
        } else {
            console.log('No data found.');
        }
    }, function(response) {
        console.log('Error: ' + response.result.error.message);
    });
}


        function displayBooks(books) {
            const booksContainer = document.getElementById('libri');
            booksContainer.innerHTML = '';
            books.forEach((book) => {
                const title = book[0];
                const status = book[1] || 'Disponibile';
                booksContainer.innerHTML += `<div class="book row">
                    <div class="col-md-6">
                        <p>${title}</p>
                    </div>
                    <div class="col-md-6">
                        <button onclick="registerAction('${title}', '${status}')" class="btn btn-${status === 'Disponibile' ? 'success' : 'secondary'}">
                            ${status === 'Disponibile' ? 'Registra Prestito' : 'Registra Restituzione'}
                        </button>
                    </div>
                </div>`;
            });
        }

        function registerAction(title, status) {
            var email = GoogleAuth.currentUser.get().getBasicProfile().getEmail();
            console.log(`Book: ${title}, Action: ${status}, by: ${email}`);
            // Qui dovresti aggiornare il foglio di calcolo con le nuove informazioni
        }

        function signOut() {
            var auth2 = gapi.auth2.getAuthInstance();
            auth2.signOut().then(function () {
                console.log('User signed out.');
            });
        }

        gapi.load('client:auth2', initClient);
    </script>
</body>
</html>

